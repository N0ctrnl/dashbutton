#include <time.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <assert.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

static uint16_t crc16(const uint8_t *ptr, int len) {
  uint16_t value = 0xffff;
  uint8_t b = len; /* crc includes length byte! */
  unsigned int i, cnt=0;

  while ( len >= cnt ) {
    uint16_t mask = 0x80;
    for ( i = 0; i <= 7; i++ ) {
      uint16_t set = value >> 15;
      value<<=1;
      if ( mask & b )
        ++value;
      value ^= 0x1021 * set;
      mask >>= 1;
    }
    b = ptr[cnt++];
  }
  return value;
}

#define SYMBOL_LEN	196

static int16_t *silence = NULL;
static int silence_len = 26 * SYMBOL_LEN;

static int16_t carriers[4][SYMBOL_LEN];

static void load_carriers(void) {
	const char fnames[4][16]={"18130.raw",  "18620.raw",  "19110.raw", "19600.raw"};
	int i;
		
	for(i=0;i<4;i++) {
		int res, fd = open(fnames[i], O_RDONLY);
		assert(fd>=0);
		res = read(fd, carriers[i], SYMBOL_LEN * sizeof(int16_t));
		assert(res == (SYMBOL_LEN * sizeof(int16_t)));
		close(fd);
	}
	
	silence = malloc(silence_len * sizeof(int16_t));
	memset(silence, 0, silence_len * sizeof(int16_t));
}

static void write_symbol(int symbol) {
	write(1,carriers[symbol],SYMBOL_LEN * sizeof(int16_t));
}

static void write_silence(void) {
	write(1,silence,silence_len * sizeof(int16_t));
}

static void encode_byte(uint8_t d) {
	int i;
	//fprintf(stderr,"%02x ",d);
	for(i=4;i;i--,d>>=2) {
		int symbol = (d&3);
		//fprintf(stderr,"%d ",symbol);
		write_symbol(symbol);
	}
	//fputc('\n',stderr);
}

static void encode(uint8_t *d, int n) {
	for(;n;d++,n--)
		encode_byte(*d);
}

static const int preamble[] = {1,0,1,2,3, 0,1,1,2,3, -1};

static void write_preamble(void) {
	int i;
	for(i=0;preamble[i]>=0;i++)
		write_symbol(preamble[i]);
}

static int hexparse(char *d) {
	uint8_t *dst = (uint8_t *)d;
	int len = 0;
	for(;*d >= '0';d+=3,dst++,len++)
		*dst = strtoul(d,NULL,16);
	return len;
}

static void hexdump(const uint8_t *d, int n) {
	for(;n;n--,d++)
		fprintf(stderr,"%02x ",*d);
	fputc('\n',stderr);
}

int main(int argc, char **argv) {
	uint8_t inbuf[256];
	int32_t len, i;
	
	load_carriers();
	
	fgets((char*)inbuf+1+2+4, sizeof(inbuf)-1-2-4, stdin);
	len = hexparse((char*)inbuf+1+2+4);

	srand(time(NULL));
	i=rand();
	memcpy(inbuf+3,&i,4);

	len+=4;
	
	i = crc16(inbuf+3,len);
	
	len+=2;
	inbuf[2]=i>>8;
	inbuf[1]=i&0xff;
	inbuf[0]=len;
	
	hexdump(inbuf,len+1);
	
	for(i=0;i<5;i++) {
		write_preamble();
		encode(inbuf, len+1);
		write_silence();
	}
		
	return 0;
}
