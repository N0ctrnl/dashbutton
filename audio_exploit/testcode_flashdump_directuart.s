.syntax unified /* use unified assembler syntax */
.code 16        /* assemble in Thumb-2  (.thumb" can also be used) */

/*
 register arguments:
 	R1: src ptr
 	R2: UART 4 Transmit Holding Register
 	R3: UART 4 Channel Status Register
	R4: watchdog dst
	R5: watchdog value
*/

// r1 = 0x400000 -- flash start
// r2 = 0x4001C21C -- UART 4 THR
// r3 = 0x4001C214 -- UART 4 CSR
// r4 = 0x400E1450 -- watchdog dst
// r5 = 0xA5000001 -- watchdog value

    LDR     R1, =0x400000
    LDR     R2, =0x4001C21C
    LDR     R3, =0x4001C214
    LDR     R4, =0x400E1450
    LDR     R5, =0xA5000001
    
	
loop:

wait_csr:
	/* send 1 byte */
	/* Loop until CSR Bit 1 is set */

	LDR     R6, [R3]  // Load CSR to R6
	TST     R6, #2
	BEQ     wait_csr
	
	/* Send R1 lowest byte to THR and increment R1 by one */
	
	LDRB.W  R7, [R1], #1
//	STRB    R7, [R2]
	STRB    R7, [R3, #8]

	/* poke watchdog */
	STR     R5, [R4]

	/* check for end of flash */
	MOVS	R6, R1, LSR #16
	CMP		R6, #0x48
	BNE loop
	
	/* let the watchdog expire */
done:
	B done

