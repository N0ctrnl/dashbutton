.syntax unified /* use unified assembler syntax */
.code 16        /* assemble in Thumb-2  (.thumb" can also be used) */

/*

Writes a phony "customer secret" to flash.

Some versions of Dash Button firmware require that this is set in order
to consider setup complete and attempt connection to network.

This sets the customer secret to 20 arbitrary bytes (the first 20 bytes)
of flash memory in order to work around.

It ends with setting the LED to green to indicate success.

*/

// r1 = 0x400000 -- flash start
// r2 = 0x40faa5 -- write customer secret function ptr (+1 due to thumb)
// r3 = 0x40e721 -- set LED color function ptr +1

/* set up function call parameters */
PUSH {R1-R3}
MOV 	R0, R1
MOV   R1, #0x14
/* call avocado_writeCustomerSecret */
BLX   R2
POP {R1-R3}

/* set LED to green */
LDR R0, =0x00FF00
BLX R3

/* let watchdog expire */
done:
	B done
