.syntax unified /* use unified assembler syntax */
.code 16        /* assemble in Thumb-2  (.thumb" can also be used) */

/*
 register arguments:
 	R1: src ptr
 	R2: UART base
 	R3: uart tx function ptr
	R4: watchdog dst
	R5: watchdog value
*/

// r1 = 0x400000 -- flash start
// r2 = 0x4001C200 -- UART 4 base
// r3 = 0x0043B03D -- UART TX function ptr (plus 1 due to blx w/ thumb)
// r4 = 0x400E1450 -- watchdog dst
// r5 = 0xA5000001 -- watchdog value

	MOVS 	R0, R2
	MOV 	R2, #0x1000
	
loop:
	/* send 1 chunk */
	PUSH 	{R0-R3}
	BLX		R3
	POP		{R0-R3}
	
	/* ptr += chunk */
	ADDS	R1, R2

	/* poke watchdog */
	STR     R5, [R4]

	/* check for end of flash */
	MOVS	R6, R1, LSR #16
	CMP		R6, #0x48
	BNE loop
	
	/* let the watchdog expire */
done:
	B done
